function AutoSuggest(e,t){this.cur=-1,this.layer=null,this.id=e,this.url=global.urlSetting+"action=list&id="+this.id+"&text=",this.textbox=t,this.init()}!function(e){e.fn.onEnter=function(e){return this.bind("keypress",function(t){13==t.keyCode&&(t.preventDefault(),t.stopPropagation(),e.apply(this,[t]))}),this}}(jQuery);var global={url:"/Handler?",urlSetting:"/SettingHandler.aspx?",urlAdvert:"/Advert.ashx?",urlAdmin:"/Admin/Handler?"},drag={masterList:{},dragList:{},placeHolder:null,recordCover:null,ie:!1,extraWidth:-2,extraHeight:-4,moved:!1,initCalled:!1,dragOn:!1,Init:function(){drag.InitDrag(),drag.checkIE(),drag.placeHolder=document.createElement("div"),drag.placeHolder.className="placeholder",drag.placeHolder.SourceI=null,drag.recordCover=document.createElement("div"),drag.recordCover.className="record-cover",drag.dragOn=!0},checkIE:function(){var e=navigator.userAgent.toLowerCase(),t=/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e);if("ie"==t[1]&&(drag.extraHeight=-5,parseInt(t[2])<7))for(var n in drag.masterList){var a=document.getElementById(n),i=document.createElement("div");a.insertBefore(i,a.firstChild)}},InitDrag:function(){for(var e=document.getElementById("page"),t=0;t<e.childNodes.length;t++){var n=e.childNodes[t].id;if("list1"==n||"list2"==n){var a=e.childNodes[t];drag.masterList[a.id]=a;for(var i=0;i<a.childNodes.length;i++){var o=a.childNodes[i].className;if("undefined"!=typeof o&&o.indexOf("box")>-1){var s=a.childNodes[i],r=s.getElementsByTagName("div")[0].getElementsByTagName("div")[0];drag.dragList[s.id]=new drag.Drag(s,r,drag.ItemDragBegin,drag.ItemMoved,drag.ItemDragEnd)}}}}},DeInitDrag:function(){for(var e in drag.dragList)drag.dragList[e].StopListening(!0)},DragReInitialise:function(){for(var e in drag.dragList)drag.dragList[e].Dispose();drag.InitDrag()},ItemDragBegin:function(e,t){drag.dragOn&&(drag.moved=!1,$(t).css("width",parseInt(t.offsetWidth)+"px").css("top",t.offsetTop+"px").css("left",t.offsetLeft+"px").removeClass("box").addClass("drag").parent().css("zindex",10),drag.masterList[t.parentNode.id].insertBefore(drag.placeHolder,t),drag.placeHolder.style.height=parseInt(t.offsetHeight)+drag.extraHeight+"px",drag.placeHolder.SourceI=t)},ItemDragBeginPartTwo:function(e){drag.moved=!0,$(e).addClass("fade")},ItemMoved:function(e,t,n){if(drag.dragOn){drag.moved||drag.ItemDragBeginPartTwo(t);var a=drag.masterList[t.parentNode.id];n=n?n:window.event;var i=e.X+(n.offsetX?n.offsetX:n.layerX),o=e.Y+(n.offsetY?n.offsetY:n.layerY),s="",r="",l="",d=!1;for(var c in drag.masterList)d&&!r&&(r=c),c==t.parentNode.id&&(d=!0,s=l),l=c;var p=i>0?r:s;if(p&&(-8>i||a.offsetWidth-8<i)){p=drag.masterList[p],t.parentNode.style.zIndex="";var u=Math.max(p.offsetWidth,a.offsetWidth),h=Math.min(p.offsetWidth,a.offsetWidth);if(move=i>0?p.offsetWidth>a.offsetWidth?h:u:p.offsetWidth>a.offsetWidth?-u:-h,4==a.childNodes.length){var g=document.createElement("div");g.className="holder",a.appendChild(g)}a=p,pos=new drag.Position(move,0),t.style.left=parseInt(t.style.left)-move+"px",drag.dragList[t.id].ShiftStart(pos),a.appendChild(t),a.appendChild(drag.placeHolder),"holder"==a.childNodes[a.childNodes.length-3].className&&a.removeChild(a.childNodes[a.childNodes.length-3]),t.parentNode.style.zIndex=100}for(var f,v="end",m=0,$=0;$<a.childNodes.length;$++)if("undefined"!=typeof a.childNodes[$].className&&a.childNodes[$].className.indexOf("box")>-1){if(m++,f=parseInt(a.childNodes[$].offsetHeight)+4*m,f/2>=o){v=a.childNodes[$];break}o-=f}v!=drag.placeHolder&&v!=drag.placeHolder.SourceI&&(drag.placeHolder.SourceI=v,drag.moved=!0,"end"!=v?a.insertBefore(drag.placeHolder,a.childNodes[$]):a.appendChild(drag.placeHolder))}},ItemDragEnd:function(e){if(drag.dragOn){var t=drag.masterList[e.parentNode.id];null!==drag.placeHolder.SourceI&&(drag.placeHolder.SourceI=null,drag.moved?(t.replaceChild(e,drag.placeHolder),drag.UpdateSettings(e)):t.removeChild(drag.placeHolder)),$(e).removeClass("fade").removeClass("drag").addClass("box").css("width","").css("top","0px").css("left","0px").parent().css("zindex","")}},UpdateSettings:function(e){var t="drag&list="+e.parentNode.id+"&item="+e.id,n=e.nextSibling;null!==n&&(t+="&next="+n.id),settings.update(t)},Check:function(e){return drag.moved?utilities.cancel(e):void 0},Hook:function(e,t,n){"string"==typeof e&&(e=document.getElementById(e)),null!==e&&(e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n))},Unhook:function(e,t,n){"string"==typeof e&&(e=document.getElementById(e)),null!==e&&(e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n))},Position:function(e,t){this.X=e,this.Y=t,this.Add=function(e){var t=new drag.Position(this.X,this.Y);return null!==e&&(isNaN(e.X)||(t.X+=e.X),isNaN(e.Y)||(t.Y+=e.Y)),t},this.Subtract=function(e){var t=new drag.Position(this.X,this.Y);return null!==e&&(isNaN(e.X)||(t.X-=e.X),isNaN(e.Y)||(t.Y-=e.Y)),t},this.Min=function(e){var t=new drag.Position(this.X,this.Y);return null===e?t:(!isNaN(e.X)&&this.X>e.X&&(t.X=e.X),!isNaN(e.Y)&&this.Y>e.Y&&(t.Y=e.Y),t)},this.Max=function(e){var t=new drag.Position(this.X,this.Y);return null===e?t:(!isNaN(e.X)&&this.X<e.X&&(t.X=e.X),!isNaN(e.Y)&&this.Y<e.Y&&(t.Y=e.Y),t)},this.Check=function(){var e=new drag.Position(this.X,this.Y);return isNaN(e.X)&&(e.X=0),isNaN(e.Y)&&(e.Y=0),e},this.Apply=function(e){"string"==typeof e&&(e=document.getElementById(e)),null!==e&&(isNaN(this.X)||(e.style.left=this.X+"px"),isNaN(this.Y)||(e.style.top=this.Y+"px"))}},AbsCursorPos:function(e){return e=e?e:window.event,isNaN(window.scrollX)?new drag.Position(e.clientX+document.documentElement.scrollLeft+document.body.scrollLeft,e.clientY+document.documentElement.scrollTop+document.body.scrollTop):new drag.Position(e.clientX+window.scrollX,e.clientY+window.scrollY)},Drag:function(e,t,n,a,i){function o(t){return p||!u||h?void 0:(p=!0,null!==n&&n(t,e),d=drag.AbsCursorPos(t),c=new drag.Position(parseInt(e.style.left),parseInt(e.style.top)),c=c.Check(),drag.Hook(document,"mousemove",s),drag.Hook(document,"mouseup",r),utilities.cancel(t))}function s(t){if(p&&!h){var n=drag.AbsCursorPos(t);return weHaveMoved=!1,(n.X!=d.X||n.Y!=d.Y)&&(weHaveMoved=!0),n=n.Add(c).Subtract(d),n.Apply(e),null!==a&&weHaveMoved&&a(n,e,t),utilities.cancel(t)}}function r(e){return l(e),utilities.cancel(e)}function l(t){p&&!h&&(drag.Unhook(document,"mousemove",s),drag.Unhook(document,"mouseup",r),d=null,c=null,null!==i&&i(e,t),p=!1)}if("string"==typeof e&&(e=document.getElementById(e)),null!==e){var d=null,c=null,p=!1,u=!1,h=!1;this.Dispose=function(){h||(this.StopListening(!0),e=null,t=null,lowerBound=null,upperBound=null,n=null,a=null,i=null,h=!0)},this.StartListening=function(){u||h||(u=!0,drag.Hook(t,"mousedown",o))},this.StopListening=function(e){u&&!h&&(drag.Unhook(t,"mousedown",o),u=!1,e&&p&&drag.Stop())},this.ShiftStart=function(e){d=d.Add(e)},this.IsDragging=function(){return p},this.IsListening=function(){return u},this.IsDisposed=function(){return h},"string"==typeof t&&(t=document.getElementById(t)),null===t&&(t=e),this.StartListening()}}},utilities={cancel:function(e){return e||(e=window.event),e&&(e.stopPropagation&&(e.stopPropagation(),e.preventDefault()),e.cancelBubble=!0,e.cancel=!0,e.returnValue=!1),!1},toggle:function(e){return $(e).parent().parent().toggleClass("min"),!1},isIE:function(e){return e=e||navigator.userAgent,e.indexOf("MSIE ")>-1||e.indexOf("Trident/")>-1||e.indexOf("Edge/")>-1},isFirefox:function(){return navigator.userAgent.toLowerCase().indexOf("firefox")>-1},isiOS:function(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream},days:["Sun","Mon","Tues","Wed","Thur","Fri","Sat"],dayOfWeek:function(e){var t=Date.parse(e.replace("-"," "));if(isNaN(t))return"";var n=new Date(t);return utilities.days[n.getDay()]},daysLong:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayOfWeekLong:function(e){var t=Date.parse(e.replace("-"," "));if(isNaN(t))return"";var n=new Date(t);return utilities.daysLong[n.getDay()]},numericValidation:function(e){var t=e.which?e.which:e.keyCode;return t>31&&(48>t||t>57)?!1:!0},checkBrowser:function(e){if(!("true"==window.localStorage.getItem("evergreen.seenAppPrompt")||window.location.href.toLowerCase().indexOf("/forgotten")>-1)){var t,n=utilities.getMobileOperatingSystem();switch(n){case"iOS":t="itms://appsto.re/gb/wyT39.i";break;case"Android":t="market://details?id=com.ascent.phr";break;default:return void window.localStorage.setItem("evergreen.seenAppPrompt","true")}var a="To take full control of your Personal Health Record, and for the best experience on your device, download the Evergreen Life PHR app.",i={confirmShow:!0,confirmText:"Download the App!",cancelShow:!0,cancelText:"Not Now",confirmCallback:function(){window.open(t,"_blank"),window.localStorage.setItem("evergreen.seenAppPrompt","true")},cancelCallback:function(){window.localStorage.setItem("evergreen.seenAppPrompt","true")}};dialog.show(e.currentTarget,"Why not use the App?",a,i)}},getMobileOperatingSystem:function(){var e=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(e)?"Windows Phone":/android/i.test(e)?"Android":/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"iOS":"unknown"}},dialog={caller:null,show:function(e,t,n,a){var i=this;i.caller=e;var o=($("#modalDialog div.content"),$("#modalDialog_buttons"));if(o.before($("<h1>").html(t)),o.before(a.noMessageP?n:$("<p>").html(n)),a){a.data&&(i.caller.data=a.data);var s=$("#modalDialog_confirm");a.confirmText=a.confirmText||"OK",a.confirmCallback?(s.off("click",null),s.on("click",function(){i.confirm(a.confirmCallback)})):s.click(i.confirm),s.text(a.confirmText);var r=$("#modalDialog_cancel");a.cancelText=a.cancelText||"Cancel",a.cancelCallback?(r.off("click",null),r.on("click",function(){i.cancel(a.cancelCallback)})):r.click(i.cancel),r.text(a.cancelText);var l=$("#modalDialog_close");a.closeText=a.closeText||"Close",a.closeCallback?(l.off("click",null),l.on("click",function(){i.close(a.closeCallback)})):l.click(i.close),l.text(a.closeText),a.confirmShow?s.show():s.hide(),a.cancelShow?r.show():r.hide(),a.closeShow||!a.cancelShow&&!a.confirmShow?l.show():l.hide()}$("#modalDialog").show()},confirm:function(e){var t=this;return dialog.close(),e&&"function"==typeof e?void e(t.caller):!0},cancel:function(e){var t=this;return dialog.close(),e&&"function"==typeof e?void e(t.caller):!1},close:function(){$("#modalDialog").hide(),$("#modalDialog :not([template])").remove()},replaceContent:function(e){$("#modalDialog_content > p").replaceWith(e)},isOpen:function(){return $("#modalDialog").is(":visible")}},ajax={call:function(e,t){timeout.reset(),$.ajax({type:"GET",url:e+"&DynamicID="+$("#DynamicID").val(),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){ajax.check(e,t)}).fail(function(e,t,n){var a="Status: "+e.status+"\nOptions: "+t+"\nError: "+n;console.log("ajax.call error\n"+a)})},callData:function(e,t,n){timeout.reset(),t.DynamicID=$("#DynamicID").val(),$.ajax({type:"GET",url:e,data:t,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){ajax.check(e,n)}).fail(function(e,t,n){var a="Status: "+e.status+"\nOptions: "+t+"\nError: "+n;console.log("ajax.callData error\n"+a)})},check:function(e,t){e.security?iPatient.security():e.timeout?iPatient.timeout():"Internal Error"==e.error?iPatient.security():$.isFunction(t)&&t(e)}},dragger={init:function(){$("div.box.loading").each(function(){var e=$(this).attr("id"),t=$(this).attr("data-handler");t=t?window[t].onSuccess:dragger.onSuccess,ajax.call(global.url+"id="+e,t)})},initialise:function(e,t){t.find("a").click(function(t){dragger.clicked(e,t)}),t.find("a[href^='http://']").attr("target","_blank")},clicked:function(e){ajax.call(global.url+"id=Log&GadgetId="+e+"&LogType=Click")},onSuccess:function(e){var t=$("#"+e.id);t.removeClass("loading"),"External-"==e.id.slice(0,9)&&t.addClass("external"),$(".box-content",t).html(e.data),t.hasClass("HO")&&dragger.initialise(e.id,t),"Link"==t.attr("id")&&(t.find("#TextSite").onEnter(settings.link),t.find("#TextPractice").onEnter(settings.search))},addExpand:function(e){$("div.heading",e).append($("<span>",{"class":"expand",text:""}).click(lightbox.show))}},help={init:function(){$("a[href='#']").click(help.toggle),help.showReferred(),menu.init()},showReferred:function(){$("h2").click(help.toggle);var e=document.createElement("a");e.href=document.referrer;var t="h2#understanding";switch(e.pathname.substring(1,6).toLowerCase()){case"login":t="h2#login";break;case"signu":t="h2#signup"}$(t).next().show().insertAfter("div.help-page h1"),$(t).insertAfter("div.help-page h1"),$("div#PanelOverlay").insertAfter("div.help-page h1")},close:function(e){$(e).closest("div.help").hide();var t=$(e).closest("div.box").attr("id");if(""!==t){var n=global.urlSetting+"action=hideHelp&item="+t;ajax.call(n)}return!1},toggle:function(e){void 0!==e&&void 0!==e.target&&($(e.target).next().is(":visible")?$(e.target).next().slideUp():($("a[href*='#']").next().slideUp(),$(e.target).next().slideDown()),utilities.cancel(e))},overlay:function(){$("#ResetWarning").hide(),$("#ButtonToggle").text("Updating...").prop("disabled",!0).addClass("disabled");var e=global.urlSetting+"action=helpToggle";ajax.call(e,help.onSuccessOverlay)},onSuccessOverlay:function(e){null!==e&&null!==e.data&&$("#ButtonToggle").text("1"==e.data?"Turn Off":"Turn On").prop("disabled",!1).removeClass("disabled")},reset:function(){$("#WarningReset").hide(),$("#ButtonReset").text("Updating...").prop("disabled",!0).addClass("disabled");var e=global.urlSetting+"action=helpReset";ajax.call(e,help.onSuccessReset)},onSuccessReset:function(e){null!==e&&null!==e.data&&($("#ButtonToggle").text("Turn Off").prop("disabled",!1).removeClass("disabled"),$("#ButtonReset").text("Reset").prop("disabled",!1).removeClass("disabled"),$("#ResetWarning").show())}},appointments={current:[],available:[],filters:{date:null,type:null,location:null,session:null,doctor:null,time:null},init:function(){},update:function(e){var t=$(e.target),n=t.attr("data-action"),a=t.attr("data-data");if("print"==n){var i=t.attr("data-id");window.open("ViewAppointment.aspx?id="+i+"&DynamicID="+$("#DynamicID").val(),"iPatientAppointmentPrintWindow","width=450, height=520, resizable=no, toolbar=no, location=no, status=no, menubar=yes")}else appointments.doUpdate(n,a)},doUpdate:function(e,t){$("#Appointments").addClass("loading");var n=global.url,a={id:"Appointments"};if(e&&(a.action=e),t)if("string"==typeof t)a.actionid=t;else for(var i in t)a[i]=t[i];ajax.callData(n,a,appointments.onSuccess)},onSuccess:function(e){var t=$("#Appointments");t.removeClass("loading"),appointments.replaceContent($(".box-content",t),e.data),appointments.init()},replaceContent:function(e,t){e.empty();var n=$("<div/>",{"class":"appointments"});appointments.clearFilters(),t.error&&n.append($("<div>",{"class":"error",text:t.error})),t.practice&&n.append($("<span>",{"class":"practice-message",text:t.practice})),t.message&&n.append($("<span>",{"class":"message",html:t.message})),t.available&&(appointments.available=t,n.append(appointments.getFilters())),n.append($("<div>",{id:"AppList"})),t.buttonPrint&&n.append(appointments.getButtonDiv(t.buttonPrint)),t.button&&n.append(appointments.getButtonDiv(t.button)),e.append(n),t.current?(appointments.current=t,appointments.addCurrent()):t.available&&appointments.addAvailable()},addCurrent:function(){var e=$("#AppList"),t=!0;$.each(appointments.current.current,function(n,a){t=!t;var i=$("<div>",{"class":"appointment current"});t&&i.addClass("alt"),i.append($("<span>",{"class":"date",html:utilities.dayOfWeekLong(a.date)+"<br/>"+a.date})),i.append($("<span>",{"class":"gp",text:a.gp})),i.append($("<span>",{"class":"time",html:a.time})),i.append("Telephone"==a.status?$("<span>",{"class":"telephone",html:"This is a telephone appointment"}):$("<span>",{"class":"location",html:a.location})),i.append($("<button>",{"class":"cancel",text:"Cancel",title:"Cancel this appointment"}).click(appointments.cancel));var o=$("<div>",{"class":"details"});i.append(o);var s=$("<div>",{"class":"cancel-confirm",text:"Are you sure you wish to cancel this appointment?"});o.append(s);var r=$("<div>",{"class":"buttons"});s.append(r),r.append($("<button>",{text:"Yes",title:"Yes - Cancel this appointment","data-id":a.id,"class":"yes warning"}).click(appointments.cancel)),r.append($("<button>",{text:"No",title:"No - Keep this appointment","class":"no"}).click(appointments.cancel)),e.append(i)})},getFilters:function(){var e=$("<div>",{id:"Filters"});return e.append(appointments.getDropDown("Type","Appointment type",appointments.available.types,appointments.onDrop,!1,["General","GP","Normal"])),e.append($("<span>",{text:"Choose Doctor or Location","class":"filter-add"}).click(appointments.filterAdd)),e},getDropDown:function(e,t,n,a,i,o){null===o&&(o=[]);var s=$("<div>",{id:"Filter"+e});return s.append($("<label>",{text:t+":","for":"FilterOn"+e})),s.append($("<span>",{id:"FilterCurrent"+e,"class":"filter-current",display:"none"}).click(appointments.resetFilter)),$select=$("<select>",{id:"FilterOn"+e}),i&&$select.append($("<option>",{value:-1,text:"Select "+t})),$.each(n,function(e){var t=$("<option>",{value:e}).html(this);$.inArray(this+"",o)>-1&&t.prop("selected",!0),i&&t.prop("disabled",!0),$select.append(t)}),$select.change(a),s.append($select),1===n.length&&""===n[0]&&s.hide(),s},filterAdd:function(){var e=$("#Appointments #Filters");e.find(".filter-add").hide(),e.append(appointments.getDropDown("Location","Location",appointments.available.locations,appointments.onDropSub,!0)),e.append(appointments.getDropDown("Session","Session",appointments.available.sessions,appointments.onDropSub,!0)),e.append(appointments.getDropDown("Doctor","Clinician",appointments.available.doctors,appointments.onDropSub,!0)),appointments.updateFilters()},onDrop:function(){appointments.clearFilters(),appointments.addAvailable()},onDropSub:function(e){var t=$(e.target);t.hide(),t.closest("div").find(".filter-current").addClass("active").text(t.find("option:selected").html()),appointments.addAvailable()},resetFilter:function(e){var t=$(e.target);t.removeClass("active"),t.closest("div").find("select").val("-1").show(),appointments.addAvailable()},updateFilters:function(){var e=$("#Appointments #Filters"),t=e.find("#FilterOnType");appointments.filters.type=t.val();var n=$.grep(appointments.available.available,function(e){return e[1]==appointments.filters.type}),a=e.find("#FilterOnLocation");a.length&&a.val()>-1?(appointments.filters.location=a.val(),n=$.grep(n,function(e){return e[2]==appointments.filters.location})):appointments.filters.location=null;var i=e.find("#FilterOnSession");i.length&&i.val()>-1?(appointments.filters.session=i.val(),n=$.grep(n,function(e){return e[3]==appointments.filters.session})):appointments.filters.session=null;var o=e.find("#FilterOnDoctor");o.length&&o.val()>-1?(appointments.filters.doctor=o.val(),n=$.grep(n,function(e){return e[4]==appointments.filters.doctor})):appointments.filters.doctor=null;var s={locations:{"-1":!0},sessions:{"-1":!0},doctors:{"-1":!0}};return $.each(n,function(e,t){s.locations[t[2]]=!0,s.sessions[t[3]]=!0,s.doctors[t[4]]=!0}),appointments.showFilterOptions(s.locations,a),appointments.showFilterOptions(s.sessions,i),appointments.showFilterOptions(s.doctors,o),n},showFilterOptions:function(e,t){t.length&&(t.find("option").prop("disabled",!0),$.each(e,function(e){t.find("option[value="+e+"]").prop("disabled",!1)}))},addAvailable:function(){$content=$("#Appointments div.appointments"),$content.find("#Filters").show(),$content.find("span.practice-message").show();var e=$content.find("#AppList");e.length||(e=$("<div>",{id:"AppList"}),$content.append(e)),e.empty();var t=appointments.updateFilters();if(null===appointments.filters.date||null===appointments.filters.time)appointments.addAvailableTimes(t,e);else{t=$.grep(t,function(e){return appointments.available.dates[e[0]]===appointments.filters.date&&-1!==appointments.available.times[e[5]].indexOf(appointments.filters.time)});var n="<b>";n+="AM"==appointments.filters.time?"Morning":"Afternoon",n+="</b> appointments on <b>"+utilities.dayOfWeek(appointments.filters.date)+" "+appointments.filters.date+"</b>";var a=$("<span>",{"class":"time-link",html:n}).click(appointments.clearFilter);e.append(a),appointments.addAvailableItems(t,e)}},clearFilters:function(){var e=$("#Appointments #Filters");e.find(".filter-add").show(),e.find("#FilterLocation").remove(),e.find("#FilterSession").remove(),e.find("#FilterDoctor").remove(),appointments.filters.date=null,appointments.filters.time=null},clearFilter:function(e){var t=$(e.target).closest("span");t.hasClass("time-link")&&(appointments.filters.date=null,appointments.filters.time=null),appointments.addAvailable()},addAvailableTimes:function(e,t){var n=$("<table>",{"class":"time-slots simple"});n.append($('<tr class="day-part"><td></td><td></td><th>Morning</th><th>Afternoon</th></tr>')),t.append(n);var a,i,o,s,r=!1;$.each(e,function(e,t){if(a!=t[0]){a=t[0],s=$("<tr>"),r=!r,r&&s.addClass("alt");var l=appointments.available.dates[t[0]];s.append($("<th>",{"class":"date",text:utilities.dayOfWeek(l)})),s.append($("<th>",{"class":"date",text:l})),i=$("<button>",{text:"Busy",disabled:"disabled",title:"There are no appointments available at this time","data-date":l,"data-time":"AM","class":"app-slot busy"}).click(appointments.selectTime),s.append($("<td>",{"class":"time"}).append(i)),o=$("<button>",{text:"Busy",disabled:"disabled",title:"There are no appointments available at this time","data-date":l,"data-time":"PM","class":"app-slot busy"}).click(appointments.selectTime),s.append($("<td>",{"class":"time"}).append(o)),n.append(s)}-1!==appointments.available.times[t[5]].indexOf("AM")?i.prop("disabled",!1).attr("title","Book an appointment").text("Select").removeClass("busy"):o.prop("disabled",!1).attr("title","Book an appointment").text("Select").removeClass("busy")})},selectTime:function(e){appointments.filters.date=$(e.target).attr("data-date"),appointments.filters.time=$(e.target).attr("data-time"),appointments.addAvailable()},addAvailableItems:function(e,t){var n=$("<div>",{"class":"appointment-list"});t.append(n);var a=!1,i=$("<button>",{text:"Select","class":"book"}).click(appointments.book);$.each(e,function(e,t){var o=$("<div>",{"class":"appointment available","data-id":t[7]});a=!a,a&&o.addClass("alt"),o.append('<div class="detail"></div>');var s=o.find(".detail");s.append($("<span>",{"class":"date",text:appointments.available.times[t[5]]})),s.append($("<span>",{"class":"gp",text:appointments.available.doctors[t[4]]})),s.append($("<span>",{"class":"location",text:appointments.available.locations[t[2]]})),s.append($("<span>",{"class":"session",text:appointments.available.sessions[t[3]]})),"Telephone"==appointments.available.statuses[t[6]]&&o.append($("<span>",{"class":"status",html:"This is a Telephone Appointment"})),o.append(i.clone(!0)),n.append(o)})},getError:function(e){return $("<div/>",{"class":"error",text:e})},getButtonDiv:function(e){return $("<div/>",{"class":"button"}).append(appointments.getButton(e))},getButton:function(e){var t=$("<button/>",{text:e.text});return e.action&&t.attr("data-action",e.action),e.id&&t.attr("data-id",e.id),e.data&&t.attr("data-data",e.data),e.class&&t.attr("class",e.class),t.click(appointments.update),t},cancel:function(e){utilities.cancel(e);var t=$(e.target);switch(t.text()){case"Yes":appointments.doUpdate("cancel",{actionid:t.attr("data-id")});break;case"No":t.closest(".appointment").removeClass("open").find(".details").slideUp(function(){t.closest(".appointment").find("button.cancel").show()});break;case"Cancel":t.closest(".appointment").find(".details").slideDown(),t.hide()}},book:function(e){var t=$(e.target);t.closest(".appointment").addClass("alt").siblings().hide(),t.hide();var n=t.closest(".appointments");n.find("#Filters").hide(),n.find("span.time-link").hide(),n.find("span.practice-message").hide(),n.find("div.appointment-list").css("overflow-y","unset");var a=t.parent();a.addClass("selected");var i=a.find(".detail");i.prepend($("<div>",{"class":"date",text:utilities.dayOfWeekLong(appointments.filters.date)+" "+appointments.filters.date})),i.prepend($("<h4>",{text:"Your appointment details:"}));var o=i.find(".gp");if(o.detach().appendTo(i),o.prepend("<span>Your appointment will be with</span>"),i.append($("<div>",{"class":"vertical-line"})),a.find("span.status").length){var s=$("<div>",{"class":"telephone"}).appendTo(a),r="This appointment is a telephone call";s.append($("<h4>",{text:r})),s.append($("<input>",{id:"TextTelephone",type:"tel",placeholder:"Your Telephone number","class":"input-light","data-type":"telephone"}).onEnter(appointments.confirm).blur(validation.blur)),s.append($("<span>",{id:"ErrorBlankTelephone","class":"hidden",text:"Please enter a telephone number"})),s.append($("<span>",{id:"ErrorInvalidTelephone","class":"hidden",text:"Please ensure your telephone number only contains numbers, brackets or spaces"})),s.append($("<label>",{text:"Phone type:","for":"DropTelType"}));var l=$("<select>",{id:"DropTelType"}).appendTo(s);l.append($("<option>",{value:0,text:"Home"})),l.append($("<option>",{value:1,text:"Mobile"})),l.append($("<option>",{value:2,text:"Other"}))}if(2!=appointments.available.reason){var d=$("<div>",{"class":"reason"}).appendTo(a),c=1==appointments.available.reason?"You may":"You <b>MUST</b>",p=1==appointments.available.reason?"optional":"required";c+=" enter a reason for this appointment. Max 60 characters (about 10 words).  This may not be read until your appointment, and may be read by non-clinical staff.)",d.append($("<h4>",{text:"Appointment Reason"})),d.append($("<input>",{id:"TextAppReason",type:"text",maxlength:"60",placeholder:"Briefly describe your appointment reason","class":"input-light","data-type":"reason-"+p}).onEnter(appointments.confirm).blur(validation.blur)),d.append($("<div>",{html:c})),d.append($("<span>",{id:"ErrorBlankAppReason","class":"hidden",text:"Please enter a reason"})),d.append($("<span>",{id:"ErrorInvalidAppReason","class":"hidden",text:"Please ensure the reason for your appointment contains only letters, numbers or basic punctuation such as ,.!£%*()+-=@'~#>?/:"})),d.append($("<div>",{"class":"vertical-line"}));var u=d.find(".vertical-line");u.css("top",d.position().top+38)}var h=$("<div>",{"class":"button"});h.append($("<button>",{text:"Cancel","class":"return"}).click(appointments.addAvailable)),h.append($("<button>",{text:"Book Appointment","class":"app-book"}).click(appointments.confirm)),a.append(h)},confirm:function(e){var t=$(e.target),n=t.closest(".appointment"),a=n.find("#TextAppReason"),i=!0,o={actionid:n.attr("data-id"),bookingReason:a.val()};a.hasClass("error")&&(i=!1);var s=n.find("#TextTelephone");s.length&&(validation.checkEl(s),s.on("input",validation.check).off("blur"),o.telephone=s.val(),o.telephoneType=n.find("#DropTelType").val(),s.hasClass("error")&&(i=!1)),i&&appointments.doUpdate("book",o)}},prescriptions={update:function(e,t){$("#Prescriptions").addClass("loading");var n=global.url,a={id:"Prescriptions"};if(void 0!==e&&(a.action=e),void 0!==t)for(var i in t)a[i]=t[i];return ajax.callData(n,a,prescriptions.onSuccess),!1},onSuccess:function(e){dragger.onSuccess(e),$("#Prescriptions [type=checkbox]").click(prescriptions.updateOrder),$("#Prescriptions tr:not(.disabled) td:not(.reason)").click(prescriptions.updateSelected),$("#Prescriptions a").click(function(e){e.stopPropagation()})},order:function(){var e="";if($("#Prescriptions input:checked").each(function(){e+=$(this).attr("id").replace("prescription-","")+","}),""===e)alert("Please select a prescription to order");else{var t={actionID:e.substr(0,e.length-1)},n=$("#prescription-reason");""!==n.val()&&"Please enter your reason for the repeat prescription here."!=n.val()&&(t.reason=n.val()),prescriptions.update("order",t)}return!1},updateOrder:function(e){e.stopPropagation(),void 0!==e&&void 0!==e.target&&$(e.target).closest("tr").toggleClass("selected").next().toggleClass("selected"),0===$("#Prescriptions input:checked").length?($("#Prescriptions input[name='prescription-reason']").prop("disabled",!0),$("#Prescriptions button:contains('Order')").prop("disabled",!0)):($("#Prescriptions input[name='prescription-reason']").prop("disabled",!1).focus(),$("#Prescriptions button:contains('Order')").prop("disabled",!1).off("click").click(prescriptions.order))},updateSelected:function(e){if(void 0!==e&&void 0!==e.target){var t=$(e.target).closest("tr");$(e.target).hasClass("details")&&(t=t.prev()),t.find("input[type=checkbox]").trigger("click")}}},messages={update:function(e,t){$("#Messages").addClass("loading");var n=global.url,a={id:"Messages"};if(e&&(a.action=e),t)for(var i in t)a[i]=t[i];return ajax.callData(n,a,messages.onSuccess),!1},onSuccess:function(e){if(void 0!==e.error&&e.error.length>0)messages.error.show(e.error);else{var t=$("#Messages");t.removeClass("loading"),$(".box-content",t).html(e.data)}},error:{show:function(e){var t=$("#Messages").addClass("loading");$error=$("<div/>",{"class":"error message"}).append($("<a/>",{"class":"close"}).on("click.messages",messages.error.hide)).append(e),$error.fadeIn(300),t.append($error),$(".box-content",t).on("click.messages",messages.error.hide)},hide:function(){var e=$("#Messages").removeClass("loading");$(".box-content",e).off("click.messages");$("div.error",e).fadeOut(300,function(){$(this).remove()})}},list:function(){return messages.update("list"),!1},send:function(e){utilities.cancel(e);var t=0,n="",a={},i=$("#messageSubject").val();i.length>0&&(i.length>200?n+="Please ensure the subject of your message is less than 200 characters.  It is currently "+i.length+".\n":(a.messageSubject=i,++t));var o=$("#messageBody").val();return o.length>0&&(o.length>500?n+="Please ensure the main content of your message is less than 500 characters.  It is currently "+o.length+".\n":(a.messageBody=o,++t)),2==t?messages.update("send",a):(0===n.length&&(n="Please ensure you enter both a subject and a message body in order to send a message."),messages.error.show(n)),!1},read:function(e,t){utilities.cancel(e),messages.update("read",{actionid:t})},"delete":function(e,t){utilities.cancel(e);var n={confirmText:"Yes",cancelText:"No",confirmCallback:function(){messages.update("delete",{actionid:t})},confirmShow:!0,cancelShow:!0};dialog.show(e.currentTarget,"Warning","Are you sure you wish to delete this message?",n)}},record={id:"Record",update:function(e){$("#"+record.id).addClass("loading");var t=global.url+"id="+record.id;null!==e&&e.length>0&&(t+="&"+e),ajax.call(t,record.onSuccess)},updateView:function(e,t,n){utilities.cancel(t);var a="record="+e;null!==n&&(a+="&page="+n),record.tabs.slideUp(),record.update(a)},onSuccess:function(e){$("#"+record.id).removeClass("loading"),$("#"+record.id+" .record-viewer-content").length?$("#"+record.id+" .record-viewer-content").html(e.data).scrollTop(0):$("#"+record.id+" .box-content").html(e.data).scrollTop(0),"Letters"==e.record&&$("#record-view a").click(attachment.view),record.onSuccessNavigator(e),record.tabs.update(e),record.sys.update(e),record.sort.update(e)},onSuccessNavigator:function(e){e.navigator?$("#"+record.id+" .box-content").prepend(e.navigator):$("#record-tabs span").removeClass("selected").has("a:contains('"+e.displayName+"')").addClass("selected"),$(window).unbind("resize.record").on("resize.record",record.resize),record.resize()},resize:function(){if(iPatient.windowLargeEnoughForBoxes()){var e=$("#record-tabs").outerHeight();$("#record-view").css("margin-top",e-1+"px")}else $("#record-view").css("margin-top","0")},print:function(e){utilities.cancel(e),record.tabs.toggle("Print")},"export":function(e){utilities.cancel(e),record.tabs.toggle("Export")},info:function(e,t){utilities.cancel(e),t?($("#ContentPanelInfo").html("<span>Retrieving information - please wait a moment</span>"),ajax.call(global.url+"id=Info&concept="+t,record.onSuccessInfo),record.tabs.show("Info")):record.tabs.toggle("Info")
},onSuccessInfo:function(e){$("#ContentPanelInfo").html(e.data)},tabs:{update:function(e){e.tabs?$("#"+record.id).append(e.tabs).append('<div class="clear"></div>'):(e.print&&$("#ContentPanelPrint").replaceWith(e.print),e.export&&$("#ContentPanelExport").replaceWith(e.export))},toggle:function(e){$("#ContentPanel"+e).is(":visible")?record.tabs.slideUp():record.tabs.show(e)},show:function(e){var t=!$("#"+record.id+" .panel-info .content-info").is(":visible");record.tabs.hide(),$("#"+e+"Button").attr("class","tab-button-active"),t?$("#ContentPanel"+e).slideDown():$("#ContentPanel"+e).show()},hide:function(){$("#"+record.id+" .panel-info .content-info").hide(),$("#"+record.id+" .panel-info .panel-tab span").attr("class","tab-button")},slideUp:function(){$("#"+record.id+" .panel-info .content-info").slideUp(),$("#"+record.id+" .panel-info .panel-tab span").attr("class","tab-button")}},sys:{update:function(e){"RecordSystem"==e.record&&$("#"+record.id+" .box-content tr.system").click(function(){record.sys.toggle(this,event)})},toggle:function(e,t){utilities.cancel(t);var n=$(e).find("td").attr("id");if(e.hasContent){var a=$("#"+n+"-row");e.isOpen?a.hide():a.show(),e.isOpen=!e.isOpen}else{e.hasContent=!0,e.isOpen=!0;var i=e.parentNode,o=i.insertRow(e.rowIndex+1);o.id=n+"-row";var s=(o.insertCell(0),o.insertCell(1));s.id=n+"-data",s.className="system-update",s.innerHTML="Updating "+$(e).find("a").html()+"...";var r="id="+record.id+"&record=RecordSystem&code="+n.replace("recSys_","");record.tabs.slideUp(),ajax.call(global.url+r,record.sys.onSuccess)}},onSuccess:function(e){$("#recSys_"+e.code+"-data").attr("class","system").html(e.data)}},sort:{update:function(e){if(e.sort){console.log(e);var t=$("<div>",{"class":"sorter"}),n=$("<a>",{href:"#",text:"Sorted by "+record.sort.label(e.sort.cur)+" "+record.sort.labelDir(e.sort.dir)}).click(record.sort.toggle);t.append(n);var a=$("<div>",{"class":"sort-options",text:"Sort by:","data-type":e.displayName});for(var i in e.sort.options){var o=$("<div>",{"data-field":i});o.append($("<a>",{text:record.sort.label(i),"class":"sort-name","data-dir":0}).click(record.sort.doSort)),o.append($("<a>",{text:" "+record.sort.labelDir(!0),"data-dir":1}).click(record.sort.doSort)),a.append(o)}t.append(a),$("#record-view").prepend(t)}},label:function(e){switch(e+""){case"1":return"Clinician";case"2":return"Location";default:return"Date"}},labelDir:function(e){return e?"(Descending)":""},toggle:function(){$("div.sort-options").toggle()},doSort:function(e){utilities.cancel(e);var t=$(window.event.target),n=t.closest("div.sort-options").attr("data-type"),a=t.closest("div").attr("data-field"),i=t.attr("data-dir"),o="record="+n+"&sort="+a+"&dir="+i;record.tabs.slideUp(),record.update(o)}}},attachment={view:function(e){if(void 0!==e&&void 0!==e.target){$("#overlay").show().attr("data-id",$(e.target).attr("data-id")),$(document).on("keyup.attachment",attachment.keyup),$(document).on("touchmove.attachment",function(e){e.preventDefault()}),$("body").addClass("modal-open");var t=global.url+"id=Attachment&attachmentID="+$(e.target).attr("data-id");utilities.isIE&&(t+="&ie=1"),ajax.call(t,attachment.update),utilities.cancel(e)}},update:function(e){var t=e.data;if($("#overlay").attr("data-id")==t.id){var n=$("#overlay-holder"),a=$("#overlay-content");if(a.length){a.css("overflow","hidden");var i=parseInt(t.width),o=$(window).width();a.css("width","calc(100% - 40px)"),200>i&&(i=200),0===i||i+40>o?(n.css("width","80%"),a.css("overflow","hidden")):n.css("width",i+40+"px");var s=parseInt(t.height),r=$(window).height();a.css("height","100%"),utilities.isiOS()&&700>r&&a.css("height","calc(100% - 40px)"),0===s||s+30>r?(n.css("height","80%"),a.css("overflow","hidden")):n.css("height",s+"px");var l=$("<div>",{style:"height: 100%;"});switch(t.doctype){case"application/pdf":l.append(utilities.isIE()?$("<iframe/>",{src:"ViewDocument.ashx?id="+t.id,width:"100%",height:"100%"}):$("<iframe/>",{src:"data:"+t.doctype+";base64,"+t.data,width:"100%",height:"100%"}));break;case"text/html":if(utilities.isIE()){var d=$("<iframe/>",{width:"100%",height:"100%"});l.append(d);var c=d[0].contentWindow.document,p=$("body",c);p.html(t.data)}else utilities.isFirefox()&&(t.data=t.data.replace(/#xa0;/g,"nbsp;")),l.append($("<iframe/>",{src:"data:"+t.doctype+","+t.data,width:"100%",height:"100%"}));break;default:l.append($("<img/>",{src:"data:"+t.doctype+";base64,"+t.data,width:t.width,height:t.height}))}a.on("touchmove.attachment",function(e){e.preventDefault()}),a.html(l)}}},close:function(){$("#overlay").hide(),$("body").removeClass("modal-open"),$(document).unbind("keyup.attachment"),$(document).unbind("touchmove.attachment");var e=$("#overlay-holder"),t=$("#overlay-content");return t.length&&(e.css("width","300px"),t.css({width:"300px",height:"300px"}),t.html("Please wait while your attachment is retrieved.")),!1},keyup:function(e){27==e.which&&attachment.close()}},advert={details:[],init:function(){if($(".page").removeClass("skyscraper-margin"),$("#AdvertBanner").length){var e=global.urlAdvert;ajax.call(e,advert.done)}else advert.showApp()},done:function(e){e.skyscraper&&($(".page").addClass("skyscraper-margin"),advert.populate(e.skyscraper,"Advert")),e.banner&&(advert.populate(e.banner,"AdvertBanner"),advert.hideApp())},showApp:function(){},hideApp:function(){$("#MobileApp").hide()},populate:function(e,t){var n=$("<img/>",{src:"data:"+e.imageType+";base64,"+e.image,onclick:"advert.click("+e.id+")",alt:"Health promotion for "+e.name});$("#"+t).html(n),advert.details[e.id]=e.link},click:function(e){window.open(advert.details[e]);var t=global.urlAdvert+"action=click&id="+e;ajax.call(t,advert.clickDone)},clickDone:function(){}},settings={init:function(){$("#SupportedServices").click(function(){$(this).toggleClass("active")}),$("#TextSite").onEnter(settings.link),$("#TextPractice").onEnter(settings.search),$("#TableChange").onEnter(function(){$("#ButtonSave").click()}),$("#TableSecurity").onEnter(function(){$("#ButtonSaveSecurity").click()}),$(".expandable").click(settings.i.toggle)},i:{toggle:function(e){utilities.cancel(e),$(this).hasClass("open")?settings.i.hide():(settings.i.hide(),$(document).on("click.hideiDetails",settings.i.hideOnClick),$(this).addClass("open").find("span").slideToggle("fast"))},hide:function(){$(document).off("click.hideiDetails"),$(".expandable").removeClass("open").find("span").slideUp("fast")},hideOnClick:function(e){var t=$("td.open");t.is(e.target)||0!==t.has(e.target).length||settings.i.hide()}},confirmID:function(e){utilities.cancel(e),"Record"==$(e.target).closest(".box").attr("id")?ajax.call(global.urlSetting+"action=identity",record.update):alert("Hello!")},consent:function(e){utilities.cancel(e);for(var t=!0,n=1;5>n;n++){var a=$("#consentCheck"+n);a.prop("checked")?a.closest("div").removeClass("error"):(t=!1,a.closest("div").addClass("error"))}t?"Record"==$(e.target).closest(".box").attr("id")?ajax.call(global.urlSetting+"action=consent",record.update):alert("Not in record..."):($("#ConsentError").removeClass("hidden"),$("#consentPanel input[type='checkbox']").change(function(){$(this).is(":checked")?$(this).closest("div").removeClass("error"):$(this).closest("div").addClass("error")}))},update:function(e){var t=global.urlSetting+"action="+e;ajax.call(t)},setSelector:function(e){settings.update("setDefault&value="+e[e.selectedIndex].value)},setTabs:function(e){settings.update("setTabView&value="+e.checked)},cancel:function(){window.location="Settings"},showLink:function(e){$("#LinkSelect").hide(),1===e?($("#LinkLetter").show(),$("#TextSite").focus()):($("#LinkNew").show(),$("#TextPractice").focus())},hideLetter:function(){$("#LinkSelect").show(),$("#LinkLetter").hide(),$("#SiteNotFound").hide(),$("#SiteUnknown").hide()},hideNew:function(){$("#LinkSelect").show(),$("#LinkNew").hide(),$("#PracticeNotFound").hide(),$("#PracticeUnknown").hide()},link:function(){iPatient.go("Settings?page=gp&action=search&id="+$("#TextSite").val())},linkFromID:function(e){utilities.cancel(e);var t=e.target,n=$(t).closest(".site-item").attr("data-id"),a=$("#TextPractice").val();iPatient.go("Settings?page=gp&action=register&id="+n+"&text="+a)},search:function(){iPatient.go("Settings?page=gp&action=searchAll&id="+$("#TextPractice").val())},gadgets:{select:function(){$("tr.error").hide();var e=$("#DropDownGadgets").val(),t=$("#RowParam").hide(),n=$("#RowParamHelp").hide();if(e.length>0){if($("#ButtonAdd").prop("disabled",!1),0!==e){var a=$("#LabelParam"),i=$("#"+e);if(a.length&&i.length){t.show(),n.show(),a.html(i.val()+":");var o=$("#InputParam").val(""),s=new AutoSuggest("RowParam",o);s.coupleToSystem(e),t.data("input",s)}}}else $("#ButtonAdd").prop("disabled",!0)},add:function(){var e=$("#DropDownGadgets").val();if(e.length){$("#ButtonAdd").val("Adding Gadget...").prop("disabled",!0),url=global.urlSetting+"action=add&id="+e;var t=$("#"+e);t.length&&(url+="&value="+$("#InputParam").val()),ajax.call(url,settings.gadgets.addDone)}},addDone:function(e){if(void 0!==e.id){if("Gadget added"===e.data)return void(window.location="Settings.aspx");var t;switch(e.data){case"Parameter error Weather":t=$("#ErrorParamWeather");break;case"Gadget with that ID already exists":t=$("#ErrorExists");break;case"Parameter empty":case"Parameter error":t=$("#ErrorParam");break;default:t=$("#ErrorUnknown")}t.show(),$("#ButtonAdd").val("Add Gadget").prop("disabled",!1)}},"delete":function(e){if(id=e.parentNode.parentNode.parentNode.id,null!==id){newid=id.replace(/\+/g,"\\+");var t=$("#"+newid+"-delete"),n=$("#"+newid);if(t.length&&n.length){var a=t.val();t.val("Deleting..."),t.addClass("disabled"),n.addClass("delete");var i=function(){n.hide();var e=global.urlSetting+"action=remove&id="+id;ajax.call(e,settings.gadgets.deleteDone)},o=function(){t.val(a),t.removeClass("disabled"),n.removeClass("delete")},s={confirmShow:!0,confirmText:"Yes",confirmCallback:i,cancelShow:!0,cancelText:"No",cancelCallback:o};dialog.show(e,"Warning","Are you sure you wish to remove this gadget?",s)}}},deleteDone:function(){var e=$("#PanelUserGadgets > div:visible");e.length||$("#PanelUserGadgetsEmpty").show()},hide:function(e){var t=1;if($button=$(e),$button.length){"Hide"==$button.text()&&(t=0),$button.val("Updating..."),$button.prop("disabled",!0),$button.addClass("disabled");var n=e.parentNode.parentNode.parentNode.id,a=global.urlSetting+"action=visibility&id="+n+"&visible="+t;ajax.call(a,settings.gadgets.hideDone)}},hideDone:function(e){if(void 0!==e.id&&void 0!==e.data){var t=$("#"+e.id),n=$("#"+e.id+"-hide"),a=t.find("select");if("undefined"!=typeof t&&"undefined"!=typeof n){switch(e.data){case"Visible":t.removeClass("disabled"),n.text("Hide"),a.prop("disabled",!1);break;case"Hidden":t.addClass("disabled"),n.text("Display"),a.prop("disabled",!0);break;case"Setting unchanged":alert("We were unable to update your settings at this time."),t.hasClass("disabled")?(n.text("Hide"),a.prop("disabled",!0)):(n.text("Display"),a.prop("disabled",!1))}n.prop("disabled",!1),n.removeClass("disabled")}}}}},lightbox={placeholder:null,container:null,content:null,title:null,init:function(){},close:function(){$(window).unbind("resize.lightbox");var e=lightbox.placeholder.parent();return e.find("span.expand").off("click").on("click",lightbox.show).removeClass("shrink"),lightbox.container.css({position:"relative",top:0,left:0,width:"100%",height:"100%","z-index":1}),$("#lightbox").hide(),lightbox.placeholder.remove(),$("#lightbox-content").html(""),lightbox.placeholder=null,lightbox.container=null,lightbox.content=null,lightbox.title=null,!1},show:function(e){e.length||(e=$(this)),lightbox.placeholder=$("<div>",{"class":"hold"});var t=$(e.parents(".box"));lightbox.container=t.find(".box-content");var n=t.clone();lightbox.placeholder.height(lightbox.container.height()).insertAfter(lightbox.container),lightbox.content=n.find(".box-content").html(""),lightbox.title=n.find(".box-title"),n.find("span.expand").unbind("click").on("click",lightbox.close).addClass("shrink"),$("#lightbox").show().click(lightbox.close),$("#lightbox-content").append(n).click(lightbox.catchEvent);var a=lightbox.content.offset();lightbox.container.css({position:"fixed",top:a.top,left:a.left,"z-index":99999}).width(lightbox.content.width()).height(lightbox.content.height()-lightbox.title.outerHeight()-4),$(window).on("resize.lightbox",lightbox.resize)},resize:function(){if(lightbox.placeholder.length&&lightbox.container.length&&lightbox.content.length&&lightbox.title.length){var e=lightbox.content.offset();lightbox.container.css({top:e.top,left:e.left}),lightbox.container.width(lightbox.content.width()).height(lightbox.content.height()-lightbox.title.outerHeight()-4)}},catchEvent:function(){event.stopPropagation()}};AutoSuggest.prototype.init=function(){var e=this;this.textbox.keyup(function(t){t||(t=window.event),e.handleKeyUp(t)}),this.textbox.keydown(function(t){return t||(t=window.event),e.handleKeyDown(t),t.returnValue}),this.textbox.blur(function(){e.hideSuggestions()}),this.createDropDown()},AutoSuggest.prototype.coupleToSystem=function(e){this.url=global.urlSetting+"action=listSys&id="+this.id+"&sysid="+e+"&text="},AutoSuggest.prototype.selectRange=function(e,t){if(this.textbox.createTextRange){var n=this.textbox.createTextRange();n.moveStart("character",e),n.moveEnd("character",t-this.textbox.val().length),n.select()}else this.textbox.setSelectionRange&&this.textbox.setSelectionRange(e,t);this.textbox.focus()},AutoSuggest.prototype.typeAhead=function(e){if(this.textbox.createTextRange||this.textbox.setSelectionRange){var t=this.textbox.val().length;this.textbox.val(e),this.selectRange(t,e.length)}},AutoSuggest.prototype.autosuggest=function(e,t){e.length>0?(t&&this.typeAhead(e[0]),this.showSuggestions(e)):this.hideSuggestions()},AutoSuggest.prototype.handleKeyDown=function(e){switch(e.keyCode){case 38:this.previousSuggestion();break;case 40:this.nextSuggestion();break;case 13:this.hideSuggestions(),e.returnValue=!1;break;case 27:this.hideSuggestions()}},AutoSuggest.prototype.handleKeyUp=function(e){var t=e.keyCode;8==t||46==t?this.requestSuggestions(!1):32>t||t>=33&&46>=t||t>=112&&123>=t||this.requestSuggestions(!0)},AutoSuggest.prototype.hideSuggestions=function(){this.cur=-1,this.layer.hide()},AutoSuggest.prototype.highlightSuggestion=function(e){this.layer.children().removeClass("current"),this.layer.find(e).addClass("current")},AutoSuggest.prototype.createDropDown=function(){this.layer=$("<div>",{"class":"suggestions"}),this.textbox.after(this.layer),this.layer.hide().css("min-width",this.textbox.width());var e=this;this.layer.mouseover(function(t){e.highlightSuggestion(t.target)}),this.layer.mouseup(function(){e.textbox.focus()}),this.layer.mousedown(function(t){e.textbox.val($(t.target).text()),e.hideSuggestions()})},AutoSuggest.prototype.showSuggestions=function(e){var t=null;this.layer.html("");for(var n=0;n<e.length;n++)t=$("<div>",{text:e[n]}),this.layer.append(t);this.layer.show()},AutoSuggest.prototype.nextSuggestion=function(){var e=this.layer.children();if(e.length>0&&this.cur<e.length-1){var t=e[++this.cur];this.highlightSuggestion(t),this.textbox.val(t.firstChild.nodeValue)}},AutoSuggest.prototype.previousSuggestion=function(){var e=this.layer.children();if(e.length>0&&this.cur>0){var t=e[--this.cur];this.highlightSuggestion(t),this.textbox.val(t.firstChild.nodeValue)}},AutoSuggest.prototype.requestSuggestions=function(e){var t="0";if(e&&(t="1"),this.textbox.val().length>0){var n=this.url+this.textbox.val()+"&ta="+t;ajax.call(n,this.done)}},AutoSuggest.prototype.handleSuggestions=function(e,t){var n=!0;"1"!=t&&(n=!1);var a=[],i=this.textbox.val();if(i.length>0){if(e)for(var o=0;o<e.length;o++)0===e[o].toLowerCase().indexOf(i.toLowerCase())&&a.push(e[o]);this.autosuggest(a,n)}},AutoSuggest.prototype.done=function(e){if(void 0!==e&&void 0!==e.id&&(gadget=$("#"+e.id),gadget.length)){var t=gadget.data("input");void 0!==t&&t.handleSuggestions(e.data,e.ta)}};var timeout={url:global.url+"id=timer",initCalled:!1,delay:48e4,delayDisplay:1e3,timeInitial:120,time:120,timer:0,reset:function(e){void 0!==e&&(utilities.cancel(e),ajax.call(timeout.url)),$("#timeout").hide(),timeout.updateTimer()},init:function(){timeout.initCalled||(timeout.initCalled=!0,$("#LinkTimeoutContinue, #ButtonTimeoutStay").click(timeout.reset),$("#ButtonTimeoutLogout").click(iPatient.logout),timeout.updateTimer())},showWarning:function(){timeout.time=timeout.timeInitial,timeout.displayTime(),$("#timeout").show(),timeout.updateTimer(!0)},updateDisplay:function(){--timeout.time<0?iPatient.timeout():(timeout.displayTime(),timeout.updateTimer(!0))},updateTimer:function(e){clearTimeout(timeout.timer),timeout.timer=void 0!==e&&e===!0?setTimeout(timeout.updateDisplay,timeout.delayDisplay):setTimeout(timeout.showWarning,timeout.delay)},displayTime:function(){var e=parseInt(timeout.time/60)%60,t=timeout.time%60;10>t&&(t="0"+t),$("#timeout-time").html(e+":"+t)}},validation={initialised:!1,keyPressCode:0,init:function(){validation.initialised||(validation.initialised=!0,$("input[data-mask]").keypress(validation.key),$("input[data-mask]").on("input",validation.input),$("input[data-mask]").on("keydown",validation.keyDown),$("[data-type]").blur(validation.blur),$(".error[data-type], .valid[data-type]").on("input",validation.check).off("blur"))},key:function(e){(e.which<32||32<e.which&&e.which<48||57<e.which&&e.which<65||90<e.which&&e.which<97||122<e.which||$(e.target).val().length>=15)&&e.preventDefault(),validation.keyPressCode=e.which},keyDown:function(e){(8==e.which||46==e.which||32==e.which)&&(validation.keyPressCode=e.which)},input:function(e){var t=$(e.target),n=t.get(0),a=n.selectionStart,i=t.val(),o=i.length;i=i.replace(/\W+/g,""),i=i.replace(/(\w{4})(\w{4})?(\w)/,"$1 $2 $3").replace(/  /g," "),32==validation.keyPressCode&&(a>9?9==i.length?i+=" ":a+=1:a>4&&(4==i.length?i+=" ":a+=1)),t.val(i),8==validation.keyPressCode?n.setSelectionRange(a,a):46==validation.keyPressCode?((4==a||9==a)&&a++,n.setSelectionRange(a,a)):i.length==o&&n.setSelectionRange(a,a)},blur:function(e){$(e.target).off("blur"),$(e.target).on("input",validation.check),validation.check(e)},check:function(e){validation.checkEl(e.target)},checkEl:function(e){switch($target=$(e),$target.siblings("span.valid, span.error").addClass("hidden").removeClass("valid").removeClass("error"),$target.removeClass("error").removeClass("valid"),$target.attr("data-type")){case"drop":validation.checkDrop($target);break;case"passLogin":validation.checkValue($target,/^.{4,}$/);break;case"password":validation.checkValue($target,/^(?=.*[a-z])(?=.*[A-Z])(?=.*[\d\S])[a-zA-Z0-9 \S]{8,99}$/);break;case"password-match":validation.checkPasswordMatch($target);break;case"email":validation.checkValue($target,/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/);break;case"key":validation.checkValue($target,/^[a-zA-Z0-9]{4} [a-zA-Z0-9]{4} [a-zA-Z0-9]{5}$/);break;case"number":validation.checkValue($target,/^[0-9]+$/);break;case"free-text":validation.checkValue($target,/^(?!\s*$)[0-9a-zA-Z ,.?"'!@£$%^&*(){}[:;<>\/\\\]\-\n]+$/);break;case"name":validation.checkValue($target,/^[a-zA-Z '`-]+$/);break;case"reason-optional":validation.checkValue($target,/^[a-zA-Z0-9 ",.!£%\*\(\)\+\-=\n\@\'\~\#\>\?\/\:]*$/,!0);break;case"reason-required":validation.checkValue($target,/^[a-zA-Z0-9 ",.!£%\*\(\)\+\-=\n\@\'\~\#\>\?\/\:]*$/);break;case"account-id":validation.checkValue($target,/^[0-9]{6,12}$/);break;case"telephone":validation.checkValue($target,/^[0-9() ext.-]+$/);break;case"postcode":validation.checkValue($target,/^([A-PR-UWYZ]([0-9]{1,2}|([A-HK-Y][0-9]|[A-HK-Y][0-9]([0-9]|[ABEHMNPRV-Y]))|[0-9][A-HJKS-UW])\ [0-9][ABD-HJLNP-UW-Z]{2}|(GIR\ 0AA)|(SAN\ TA1)|(BFPO\ (C\/O\ )?[0-9]{1,4})|((ASCN|BBND|[BFS]IQQ|PCRN|STHL|TDCU|TKCA)\ 1ZZ))$/i);break;default:validation.checkValue($target,/^[a-zA-Z0-9 ]+$/)}},checkDrop:function(e){var t=e.attr("id").replace("Drop","");0===e.prop("selectedIndex")?(e.addClass("error"),$("#ErrorBlank"+t).attr("class","error")):e.addClass("valid"),("Day"==t||"Month"==t||"Year"==t)&&($("#DropDay").hasClass("error")||$("#DropMonth").hasClass("error")||$("#DropYear").hasClass("error")?e.parent().addClass("error").siblings("span").addClass("error"):e.parent().removeClass("error").siblings("span").removeClass("error"))},checkPasswordMatch:function(e){validation.checkValue(e,/.*/);var t=e.attr("id").replace("Text","");!e.hasClass("class","error")&&t.endsWith("Repeat")&&e.val()!=$("#Text"+t.replace("Repeat","")).val()&&(e.addClass("error"),$("#ErrorMatch"+t).addClass("error"))},checkValue:function(e,t,n){var a=e.val(),i=e.attr("id").replace("Text","");return void 0===n&&(n=!1),0!==a.length||n?void(t.test(a)?e.addClass("valid"):(e.addClass("error"),$("#ErrorInvalid"+i).addClass("error"))):(e.addClass("error"),void $("#ErrorBlank"+i).addClass("error"))}},login={views:["pra","ccg","pat"],init:function(){validation.init(),$("div.details-item").click(login.onIconClick),$("div.back").mouseout(login.onMouseOut),0!==$("#pat").length&&(login.views.forEach(function(e){$("#"+e+"Link a").click(function(){return login.show(e),!1})}),login.show("pat"))},show:function(e){login.views.forEach(function(t){e==t?($("#"+e).show(),$("#"+e+"Link").hide()):($("#"+t).hide(),$("#"+t+"Link").show())}),"ccg"==e?$("#praLink").addClass("end"):$("#praLink").removeClass("end")},create:function(){var e=$('.login-details input[data-type="email"]').val(),t="Signup.aspx";e&&""!=e&&(t+="?un="+e),window.location=t},onIconClick:function(){$(this).toggleClass("flip")},onMouseOut:function(){$(this).parent().parent().removeClass("flip")}},warning={init:function(){$("#UserWarning").length&&$(document).on("keypress.warning",function(e){switch(e.which){case 13:case 27:case 32:warning.close()}})},close:function(){$(document).off("keypress.warning"),$("#UserWarning").hide()}},cookies={close:function(){$("#cookie").slideUp()}},email={onSuccess:function(e){var t=$("#"+e.id);t.removeClass("loading"),$(".box-content",t).html(e.data),t.find("#ButtonVerifyEdit").click(email.change),t.find("#ButtonResend").click(email.resend),t.find("#ButtonCheckKey").click(email.verify)},change:function(e){utilities.cancel(e),iPatient.go("Settings?page=account&action=change")},resend:function(e){utilities.cancel(e),iPatient.go("Settings?page=account&action=resend")},verify:function(e){utilities.cancel(e),iPatient.go("Settings.aspx?page=account&action=verify&key="+$("#TextKey").val())}},menu={init:function(){$("li.dropdown").hover(function(){$(this).children("ul.sub-menu").slideDown(200)},function(){$(this).children("ul.sub-menu").slideUp(200)}),$("li.dropdown > a").on("touchstart",function(e){utilities.cancel(e),$(this).closest("li.dropdown").children("ul.sub-menu").slideToggle(200),$(this).blur()})}},iPatient={drag:!1,mobile:!1,MIN_WIDTH_DRAGGABLE_BOXES:0,init:function(){$("button").on("click",function(e){e.preventDefault()}),$("body").on("click","button",function(e){e.preventDefault()}),$("body").on("click","a",function(){"_blank"!=this.target&&this.href.indexOf("?")>-1&&this.href.hostname!=window.location.hostname&&(this.href+="&DynamicID="+$("#DynamicID").val())}),$("#overlay-background").click(function(){attachment.close()}),$("#LinkClose").click(function(){return attachment.close()}),$("header .banner").addClass("header-animation"),$("header .banner .logo").addClass("header-animation"),$(".login-links").addClass("header-animation"),advert.init()},initSubs:function(){timeout.init(),dragger.init(),lightbox.init(),warning.init(),menu.init(),$(window).scroll(function(){$(this).scrollTop()>50?$("header").addClass("sticky"):$("header").removeClass("sticky")}),$(window).unbind("resize.iPatient").on("resize.iPatient",iPatient.resize),iPatient.windowLargeEnoughForBoxes()?iPatient.BoxEventHandlersSet_Drag():iPatient.BoxEventHandlersSet_Concertina()},resize:function(){iPatient.windowLargeEnoughForBoxes()?iPatient.BoxEventHandlersSet_Drag():iPatient.BoxEventHandlersSet_Concertina()},BoxConcertina_Click:function(){var e=$(this).closest(".box");e.hasClass("open")?e.find(".box-content").slideUp("fast",function(){e.removeClass("open")}):(e.find(".box-content").slideDown("fast"),e.addClass("open"))},BoxEventHandlersSet_Drag:function(){iPatient.drag||($("div.box-title").off("click"),$("div.box-content").show(),$("div.box").removeClass("open"),drag.Init()),iPatient.mobile=!1,iPatient.drag=!0},BoxEventHandlersSet_Concertina:function(){iPatient.mobile||($("div.box-title").off("click").on("click",this.BoxConcertina_Click),$("div.box").removeClass("open"),$("div.box-content").hide(),drag.DeInitDrag()),iPatient.mobile=!0,iPatient.drag=!1},windowLargeEnoughForBoxes:function(){return!window.matchMedia("(max-width: "+iPatient.MIN_WIDTH_DRAGGABLE_BOXES+"px)").matches},home:function(){window.location="Default"},go:function(e){e.indexOf("?")>-1&&-1==e.indexOf("http://")&&-1==e.indexOf("&DynamicID")&&-1==e.indexOf("Login?")&&(e+="&DynamicID="+$("#DynamicID").val()),window.location=e},bannerDropDownToggle:function(){var e=$("#BannerDropDown");iPatient.bannerDropDownShowHide("1"==e.attr("vis")?!1:!0)},bannerDropDownShowHide:function(e){var t=$("#BannerDropDown");e?(t.attr("vis","1"),t.css("height","100%"),t.show(),t.css("left","0px")):(t.attr("vis","0"),t.css("left","-290px"))},page:function(e){var t=this.getQuery();t.p=e,iPatient.go("?"+$.param(t))},getQuery:function(){for(var e,t={},n=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),a=0;a<n.length;a++)e=n[a].split("="),t[e[0]]=e[1];return t},open:function(e){window.open(e,"_blank")},logout:function(e){return"undefined"!=typeof e&&utilities.cancel(e),window.location="/Login?logout=1",!1},security:function(){window.location="/Login?security=1"},timeout:function(e){return"undefined"!=typeof e&&utilities.cancel(e),window.location="/Login?timeout=1",!1},scroll:function(e){var t=e.originalEvent,n=t.wheelDelta||-t.detail;this.scrollTop+=10*(0>n?1:-1),e.preventDefault()}};$(iPatient.init);